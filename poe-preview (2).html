<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        .product-image {
            aspect-ratio: 1600/2048;
            object-fit: cover;
        }
        .sync-indicator {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
    <!-- 登录页面 -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/10 to-purple-100 dark:from-primary/20 dark:to-gray-800">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">商品管理系统</h1>
                <p class="text-gray-600 dark:text-gray-400">请登录以继续</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">用户名</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base" required="">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">密码</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base" required="">
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    登录
                </button>
            </form>
            
            <!-- Google Drive 同步设置 -->
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <div class="text-sm font-medium mb-3 text-center">云端数据同步</div>
                <div id="googleDriveStatus" class="text-center text-sm text-gray-600 dark:text-gray-400 mb-3">
                    未连接 Google Drive
                </div>
                <button id="googleSignInBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                    连接 Google Drive
                </button>
                <button id="googleSignOutBtn" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm hidden">
                    断开 Google Drive
                </button>
            </div>
            
            <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- 顶部导航栏 -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-semibold text-primary">商品管理系统</h1>
                        <span id="userInfo" class="text-sm text-gray-600 dark:text-gray-400"></span>
                        <!-- 同步状态指示器 -->
                        <div class="flex items-center space-x-2">
                            <div id="syncStatus" class="text-xs text-gray-500 dark:text-gray-400">离线模式</div>
                            <div id="syncIndicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button id="dashboardBtn" class="nav-btn bg-primary text-white px-4 py-2 rounded-lg">商品管理</button>
                        <button id="userManagementBtn" class="nav-btn text-gray-600 dark:text-gray-400 px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hidden">用户管理</button>
                        <button id="categoryManagementBtn" class="nav-btn text-gray-600 dark:text-gray-400 px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">分类管理</button>
                        <button id="statsBtn" class="nav-btn text-gray-600 dark:text-gray-400 px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">统计</button>
                        <button id="syncBtn" class="text-blue-500 hover:text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20">手动同步</button>
                        <button id="logoutBtn" class="text-red-500 hover:text-red-700 px-4 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 商品管理界面 -->
        <div id="dashboardContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 搜索和添加商品栏 -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-medium mb-2">搜索商品</label>
                        <input type="text" id="searchInput" placeholder="输入商品名称搜索..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                    </div>
                    <button id="addProductBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors whitespace-nowrap">
                        添加商品
                    </button>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">商品总数</div>
                    <div id="totalProducts" class="text-2xl font-bold text-primary">0</div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">已售商品</div>
                    <div id="soldProducts" class="text-2xl font-bold text-green-500">0</div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">库存商品</div>
                    <div id="stockProducts" class="text-2xl font-bold text-blue-500">0</div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">总价值</div>
                    <div id="totalValue" class="text-2xl font-bold text-purple-500">¥0</div>
                </div>
            </div>

            <!-- 商品列表 -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold">商品列表</h2>
                </div>
                <div id="productsList" class="p-6">
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        暂无商品数据
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户管理界面 -->
        <div id="userManagementContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">用户管理</h2>
                    <button id="addUserBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90">
                        添加员工
                    </button>
                </div>
                <div id="usersList" class="p-6">
                    <!-- 用户列表将在这里生成 -->
                </div>
            </div>
        </div>

        <!-- 分类管理界面 -->
        <div id="categoryManagementContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">分类管理</h2>
                    <button id="addCategoryBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90">
                        添加分类
                    </button>
                </div>
                <div id="categoriesList" class="p-6">
                    <!-- 分类列表将在这里生成 -->
                </div>
            </div>
        </div>

        <!-- 统计界面 -->
        <div id="statsContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">分类统计</h3>
                    <div id="categoryStats">
                        <!-- 分类统计将在这里生成 -->
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">销售统计</h3>
                    <div id="salesStats">
                        <!-- 销售统计将在这里生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑商品模态框 -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 id="productModalTitle" class="text-lg font-semibold">添加商品</h3>
            </div>
            <form id="productForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">商品名称 *</label>
                    <input type="text" id="productName" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">商品图片</label>
                    <div class="space-y-3">
                        <input type="file" id="productImage" accept="image/*" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" class="product-image w-full max-w-xs mx-auto rounded-lg border">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">商品分类 *</label>
                    <select id="productCategory" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                        <option value="">请选择分类</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">售价 *</label>
                        <input type="number" id="productPrice" step="0.01" min="0" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">库存 *</label>
                        <input type="number" id="productStock" min="0" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                    </div>
                </div>
                
                <div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="productSold" class="w-5 h-5 text-primary focus:ring-primary border-gray-300 rounded">
                        <span class="text-sm font-medium">已售出</span>
                    </label>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelProductBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 id="userModalTitle" class="text-lg font-semibold">添加员工</h3>
            </div>
            <form id="userForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">用户名 *</label>
                    <input type="text" id="newUsername" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">密码 *</label>
                    <input type="password" id="newPassword" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">用户类型 *</label>
                    <select id="userRole" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                        <option value="employee">员工</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelUserBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加分类模态框 -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold">添加分类</h3>
            </div>
            <form id="categoryForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">分类名称 *</label>
                    <input type="text" id="categoryName" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base" required="">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelCategoryBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-4">确认删除</h3>
                <p id="confirmMessage" class="text-gray-600 dark:text-gray-400 mb-6">确定要删除此项目吗？此操作无法撤销。</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelConfirmBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">取消</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg">删除</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Drive API 配置
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyBqt8FWJqpU8Rqm5XZZ0QX_qHF8uKGXbZU', // 请替换为你的 API Key
            clientId: '123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com', // 请替换为你的 Client ID
            discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            scopes: 'https://www.googleapis.com/auth/drive.file',
            dataFileName: 'inventory_system_data.json'
        };

        // 深色模式支持
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Google Drive API 管理类
        class GoogleDriveSync {
            constructor() {
                this.isSignedIn = false;
                this.gapi = null;
                this.tokenClient = null;
                this.dataFileId = null;
                this.callbacks = {
                    onSignIn: null,
                    onSignOut: null,
                    onSync: null,
                    onError: null
                };
            }

            async init() {
                try {
                    // 初始化 Google API
                    await new Promise((resolve) => {
                        gapi.load('auth2:client', resolve);
                    });

                    await gapi.client.init({
                        apiKey: GOOGLE_CONFIG.apiKey,
                        discoveryDocs: [GOOGLE_CONFIG.discoveryDoc]
                    });

                    // 初始化 Google Identity Services
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CONFIG.clientId,
                        scope: GOOGLE_CONFIG.scopes,
                        callback: (response) => {
                            if (response.access_token) {
                                this.handleSignInSuccess();
                            }
                        }
                    });

                    console.log('Google Drive API 初始化成功');
                    return true;
                } catch (error) {
                    console.error('Google Drive API 初始化失败:', error);
                    return false;
                }
            }

            signIn() {
                if (this.tokenClient) {
                    this.tokenClient.requestAccessToken();
                }
            }

            signOut() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    this.isSignedIn = false;
                    this.dataFileId = null;
                    if (this.callbacks.onSignOut) {
                        this.callbacks.onSignOut();
                    }
                }
            }

            handleSignInSuccess() {
                this.isSignedIn = true;
                if (this.callbacks.onSignIn) {
                    this.callbacks.onSignIn();
                }
                // 登录成功后自动加载数据
                this.loadDataFromDrive();
            }

            async findDataFile() {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `name='${GOOGLE_CONFIG.dataFileName}' and trashed=false`,
                        spaces: 'drive'
                    });

                    if (response.result.files.length > 0) {
                        this.dataFileId = response.result.files[0].id;
                        return this.dataFileId;
                    }
                    return null;
                } catch (error) {
                    console.error('查找数据文件失败:', error);
                    return null;
                }
            }

            async createDataFile(data) {
                try {
                    const metadata = {
                        name: GOOGLE_CONFIG.dataFileName,
                        parents: ['appDataFolder']
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', new Blob([JSON.stringify(data)], {type: 'application/json'}));

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({
                            'Authorization': `Bearer ${gapi.auth.getToken().access_token}`
                        }),
                        body: form
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.dataFileId = result.id;
                        return result.id;
                    } else {
                        throw new Error('创建文件失败');
                    }
                } catch (error) {
                    console.error('创建数据文件失败:', error);
                    return null;
                }
            }

            async saveDataToDrive(data) {
                if (!this.isSignedIn) {
                    console.log('未登录 Google Drive，跳过同步');
                    return false;
                }

                try {
                    if (!this.dataFileId) {
                        await this.findDataFile();
                    }

                    const dataWithTimestamp = {
                        ...data,
                        lastSync: new Date().toISOString()
                    };

                    if (this.dataFileId) {
                        // 更新现有文件
                        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${this.dataFileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${gapi.auth.getToken().access_token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dataWithTimestamp)
                        });

                        if (!response.ok) {
                            throw new Error('更新文件失败');
                        }
                    } else {
                        // 创建新文件
                        this.dataFileId = await this.createDataFile(dataWithTimestamp);
                        if (!this.dataFileId) {
                            throw new Error('创建文件失败');
                        }
                    }

                    if (this.callbacks.onSync) {
                        this.callbacks.onSync('保存到云端成功');
                    }
                    return true;
                } catch (error) {
                    console.error('保存到 Google Drive 失败:', error);
                    if (this.callbacks.onError) {
                        this.callbacks.onError('保存到云端失败: ' + error.message);
                    }
                    return false;
                }
            }

            async loadDataFromDrive() {
                if (!this.isSignedIn) {
                    return null;
                }

                try {
                    if (!this.dataFileId) {
                        await this.findDataFile();
                    }

                    if (!this.dataFileId) {
                        console.log('云端未找到数据文件');
                        return null;
                    }

                    const response = await gapi.client.drive.files.get({
                        fileId: this.dataFileId,
                        alt: 'media'
                    });

                    if (response.body) {
                        const data = JSON.parse(response.body);
                        if (this.callbacks.onSync) {
                            this.callbacks.onSync('从云端加载成功');
                        }
                        return data;
                    }
                    return null;
                } catch (error) {
                    console.error('从 Google Drive 加载失败:', error);
                    if (this.callbacks.onError) {
                        this.callbacks.onError('从云端加载失败: ' + error.message);
                    }
                    return null;
                }
            }

            setCallbacks(callbacks) {
                this.callbacks = { ...this.callbacks, ...callbacks };
            }
        }

        // 数据存储类（增强版，支持云端同步）
        class DataStore {
            constructor() {
                this.data = {
                    users: [
                        { id: 1, username: 'admin', password: 'admin123', role: 'admin', status: 'active' }
                    ],
                    products: [],
                    categories: ['电子产品', '服装', '食品', '图书', '家居用品'],
                    currentUser: null,
                    nextProductId: 1,
                    nextUserId: 2
                };
                this.googleDrive = new GoogleDriveSync();
                this.autoSaveInterval = null;
                this.init();
            }

            async init() {
                // 初始化 Google Drive
                await this.googleDrive.init();
                
                // 设置 Google Drive 回调
                this.googleDrive.setCallbacks({
                    onSignIn: () => {
                        this.updateGoogleDriveStatus(true);
                        this.startAutoSave();
                    },
                    onSignOut: () => {
                        this.updateGoogleDriveStatus(false);
                        this.stopAutoSave();
                    },
                    onSync: (message) => {
                        this.updateSyncStatus('success', message);
                    },
                    onError: (message) => {
                        this.updateSyncStatus('error', message);
                    }
                });

                // 添加一些示例商品
                this.addProduct({
                    name: '示例商品1',
                    image: null,
                    category: '电子产品',
                    price: 299.99,
                    stock: 10,
                    sold: false
                });
                this.addProduct({
                    name: '示例商品2',
                    image: null,
                    category: '服装',
                    price: 89.99,
                    stock: 5,
                    sold: true
                });
            }

            updateGoogleDriveStatus(isConnected) {
                const statusElement = document.getElementById('googleDriveStatus');
                const signInBtn = document.getElementById('googleSignInBtn');
                const signOutBtn = document.getElementById('googleSignOutBtn');
                const syncIndicator = document.getElementById('syncIndicator');
                const syncStatus = document.getElementById('syncStatus');

                if (isConnected) {
                    statusElement.textContent = '已连接 Google Drive';
                    statusElement.className = 'text-center text-sm text-green-600 dark:text-green-400 mb-3';
                    signInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                    
                    syncIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    syncStatus.textContent = '云端同步已启用';
                } else {
                    statusElement.textContent = '未连接 Google Drive';
                    statusElement.className = 'text-center text-sm text-gray-600 dark:text-gray-400 mb-3';
                    signInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                    
                    syncIndicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    syncStatus.textContent = '离线模式';
                }
            }

            updateSyncStatus(type, message) {
                const syncStatus = document.getElementById('syncStatus');
                const syncIndicator = document.getElementById('syncIndicator');
                
                if (type === 'syncing') {
                    syncIndicator.className = 'w-3 h-3 bg-blue-400 rounded-full sync-indicator';
                    syncStatus.textContent = message || '正在同步...';
                } else if (type === 'success') {
                    syncIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    syncStatus.textContent = message || '同步成功';
                    setTimeout(() => {
                        if (this.googleDrive.isSignedIn) {
                            syncStatus.textContent = '云端同步已启用';
                        }
                    }, 3000);
                } else if (type === 'error') {
                    syncIndicator.className = 'w-3 h-3 bg-red-400 rounded-full';
                    syncStatus.textContent = message || '同步失败';
                    setTimeout(() => {
                        if (this.googleDrive.isSignedIn) {
                            syncStatus.textContent = '云端同步已启用';
                            syncIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                        }
                    }, 5000);
                }
            }

            startAutoSave() {
                this.stopAutoSave(); // 确保不会重复启动
                this.autoSaveInterval = setInterval(() => {
                    this.syncToCloud();
                }, 30000); // 每30秒自动保存一次
            }

            stopAutoSave() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                    this.autoSaveInterval = null;
                }
            }

            async syncToCloud() {
                if (this.googleDrive.isSignedIn) {
                    this.updateSyncStatus('syncing', '正在同步到云端...');
                    await this.googleDrive.saveDataToDrive(this.getDataForSync());
                }
            }

            async loadFromCloud() {
                if (this.googleDrive.isSignedIn) {
                    this.updateSyncStatus('syncing', '正在从云端加载...');
                    const cloudData = await this.googleDrive.loadDataFromDrive();
                    if (cloudData) {
                        this.mergeCloudData(cloudData);
                        return true;
                    }
                }
                return false;
            }

            getDataForSync() {
                // 返回需要同步的数据（排除当前用户信息）
                return {
                    users: this.data.users,
                    products: this.data.products,
                    categories: this.data.categories,
                    nextProductId: this.data.nextProductId,
                    nextUserId: this.data.nextUserId
                };
            }

            mergeCloudData(cloudData) {
                // 合并云端数据，保持当前登录状态
                const currentUser = this.data.currentUser;
                
                this.data = {
                    ...this.data,
                    ...cloudData,
                    currentUser: currentUser // 保持当前登录用户
                };
            }

            // Google Drive 相关方法
            async connectGoogleDrive() {
                this.googleDrive.signIn();
            }

            disconnectGoogleDrive() {
                this.googleDrive.signOut();
            }

            // 原有方法保持不变，但添加自动同步
            getUsers() {
                return this.data.users;
            }

            addUser(userData) {
                const user = {
                    id: this.data.nextUserId++,
                    ...userData,
                    status: 'active'
                };
                this.data.users.push(user);
                this.syncToCloud(); // 自动同步
                return user;
            }

            updateUser(id, userData) {
                const index = this.data.users.findIndex(u => u.id === id);
                if (index !== -1) {
                    this.data.users[index] = { ...this.data.users[index], ...userData };
                    this.syncToCloud(); // 自动同步
                    return this.data.users[index];
                }
                return null;
            }

            deleteUser(id) {
                const index = this.data.users.findIndex(u => u.id === id);
                if (index !== -1) {
                    this.data.users.splice(index, 1);
                    this.syncToCloud(); // 自动同步
                    return true;
                }
                return false;
            }

            getProducts() {
                return this.data.products;
            }

            addProduct(productData) {
                const product = {
                    id: this.data.nextProductId++,
                    ...productData,
                    createdAt: new Date().toISOString()
                };
                this.data.products.push(product);
                this.syncToCloud(); // 自动同步
                return product;
            }

            updateProduct(id, productData) {
                const index = this.data.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.data.products[index] = { ...this.data.products[index], ...productData };
                    this.syncToCloud(); // 自动同步
                    return this.data.products[index];
                }
                return null;
            }

            deleteProduct(id) {
                const index = this.data.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.data.products.splice(index, 1);
                    this.syncToCloud(); // 自动同步
                    return true;
                }
                return false;
            }

            getCategories() {
                return this.data.categories;
            }

            addCategory(categoryName) {
                if (!this.data.categories.includes(categoryName)) {
                    this.data.categories.push(categoryName);
                    this.syncToCloud(); // 自动同步
                    return true;
                }
                return false;
            }

            deleteCategory(categoryName) {
                const index = this.data.categories.indexOf(categoryName);
                if (index !== -1) {
                    this.data.categories.splice(index, 1);
                    this.syncToCloud(); // 自动同步
                    return true;
                }
                return false;
            }

            authenticate(username, password) {
                const user = this.data.users.find(u => 
                    u.username === username && 
                    u.password === password && 
                    u.status === 'active'
                );
                if (user) {
                    this.data.currentUser = user;
                    return user;
                }
                return null;
            }

            getCurrentUser() {
                return this.data.currentUser;
            }

            logout() {
                this.data.currentUser = null;
            }
        }

        // 应用程序主类
        class InventoryApp {
            constructor() {
                this.store = new DataStore();
                this.currentEditingProduct = null;
                this.currentEditingUser = null;
                this.confirmCallback = null;
                this.init();
            }

            async init() {
                this.bindEvents();
                this.showLoginPage();
                
                // 等待 Google Drive 初始化完成
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            bindEvents() {
                // 登录相关
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.handleLogout();
                });

                // Google Drive 相关
                document.getElementById('googleSignInBtn').addEventListener('click', () => {
                    this.store.connectGoogleDrive();
                });

                document.getElementById('googleSignOutBtn').addEventListener('click', () => {
                    this.store.disconnectGoogleDrive();
                });

                document.getElementById('syncBtn').addEventListener('click', () => {
                    this.manualSync();
                });

                // 导航相关
                document.getElementById('dashboardBtn').addEventListener('click', () => {
                    this.showDashboard();
                });

                document.getElementById('userManagementBtn').addEventListener('click', () => {
                    this.showUserManagement();
                });

                document.getElementById('categoryManagementBtn').addEventListener('click', () => {
                    this.showCategoryManagement();
                });

                document.getElementById('statsBtn').addEventListener('click', () => {
                    this.showStats();
                });

                // 搜索
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterProducts(e.target.value);
                });

                // 商品相关
                document.getElementById('addProductBtn').addEventListener('click', () => {
                    this.showProductModal();
                });

                document.getElementById('productForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleProductSubmit();
                });

                document.getElementById('cancelProductBtn').addEventListener('click', () => {
                    this.hideProductModal();
                });

                document.getElementById('productImage').addEventListener('change', (e) => {
                    this.handleImagePreview(e);
                });

                // 用户相关
                document.getElementById('addUserBtn').addEventListener('click', () => {
                    this.showUserModal();
                });

                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleUserSubmit();
                });

                document.getElementById('cancelUserBtn').addEventListener('click', () => {
                    this.hideUserModal();
                });

                // 分类相关
                document.getElementById('addCategoryBtn').addEventListener('click', () => {
                    this.showCategoryModal();
                });

                document.getElementById('categoryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCategorySubmit();
                });

                document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
                    this.hideCategoryModal();
                });

                // 确认删除相关
                document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
                    this.hideConfirmModal();
                });

                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    if (this.confirmCallback) {
                        this.confirmCallback();
                        this.hideConfirmModal();
                    }
                });
            }

            async manualSync() {
                if (this.store.googleDrive.isSignedIn) {
                    await this.store.syncToCloud();
                    this.refreshAllViews();
                } else {
                    this.showAlert('请先连接 Google Drive');
                }
            }

            refreshAllViews() {
                // 刷新当前显示的内容
                const activeContent = document.querySelector('[id$="Content"]:not(.hidden)');
                if (activeContent) {
                    const activeId = activeContent.id;
                    if (activeId === 'dashboardContent') {
                        this.showDashboard();
                    } else if (activeId === 'userManagementContent') {
                        this.showUserManagement();
                    } else if (activeId === 'categoryManagementContent') {
                        this.showCategoryManagement();
                    } else if (activeId === 'statsContent') {
                        this.showStats();
                    }
                }
            }

            showLoginPage() {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            async showMainApp() {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // 尝试从云端加载数据
                await this.store.loadFromCloud();
                
                this.showDashboard();
                this.updateUserInfo();
                this.updateNavigation();
            }

            async handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorElement = document.getElementById('loginError');

                const user = this.store.authenticate(username, password);
                if (user) {
                    await this.showMainApp();
                    errorElement.classList.add('hidden');
                    // 清除表单
                    document.getElementById('loginForm').reset();
                } else {
                    errorElement.textContent = '用户名或密码错误，或账户已被禁用';
                    errorElement.classList.remove('hidden');
                }
            }

            handleLogout() {
                this.store.logout();
                this.showLoginPage();
            }

            updateUserInfo() {
                const user = this.store.getCurrentUser();
                const roleText = user.role === 'admin' ? '管理员' : '员工';
                document.getElementById('userInfo').textContent = `${user.username} (${roleText})`;
            }

            updateNavigation() {
                const user = this.store.getCurrentUser();
                const userManagementBtn = document.getElementById('userManagementBtn');
                
                if (user.role === 'admin') {
                    userManagementBtn.classList.remove('hidden');
                } else {
                    userManagementBtn.classList.add('hidden');
                }
            }

            showDashboard() {
                this.setActiveNavItem('dashboardBtn');
                this.hideAllContent();
                document.getElementById('dashboardContent').classList.remove('hidden');
                this.updateProductCategories();
                this.renderProducts();
                this.updateStats();
            }

            showUserManagement() {
                this.setActiveNavItem('userManagementBtn');
                this.hideAllContent();
                document.getElementById('userManagementContent').classList.remove('hidden');
                this.renderUsers();
            }

            showCategoryManagement() {
                this.setActiveNavItem('categoryManagementBtn');
                this.hideAllContent();
                document.getElementById('categoryManagementContent').classList.remove('hidden');
                this.renderCategories();
            }

            showStats() {
                this.setActiveNavItem('statsBtn');
                this.hideAllContent();
                document.getElementById('statsContent').classList.remove('hidden');
                this.renderStats();
            }

            setActiveNavItem(activeId) {
                const navBtns = document.querySelectorAll('.nav-btn');
                navBtns.forEach(btn => {
                    if (btn.id === activeId) {
                        btn.classList.add('bg-primary', 'text-white');
                        btn.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    } else {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    }
                });
            }

            hideAllContent() {
                document.getElementById('dashboardContent').classList.add('hidden');
                document.getElementById('userManagementContent').classList.add('hidden');
                document.getElementById('categoryManagementContent').classList.add('hidden');
                document.getElementById('statsContent').classList.add('hidden');
            }

            updateProductCategories() {
                const select = document.getElementById('productCategory');
                const categories = this.store.getCategories();
                
                select.innerHTML = '<option value="">请选择分类</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            }

            renderProducts(filterText = '') {
                const container = document.getElementById('productsList');
                const products = this.store.getProducts();
                const user = this.store.getCurrentUser();
                
                const filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(filterText.toLowerCase())
                );

                if (filteredProducts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                            ${filterText ? '没有找到匹配的商品' : '暂无商品数据'}
                        </div>
                    `;
                    return;
                }

                const productsHTML = filteredProducts.map(product => `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                ${product.image ? 
                                    `<img src="${product.image}" alt="${product.name}" class="product-image w-20 h-25 rounded-lg object-cover">` :
                                    `<div class="product-image w-20 h-25 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 text-xs">无图片</div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900 dark:text-white truncate">${product.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">分类: ${product.category}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">价格: ¥${product.price}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">库存: ${product.stock}</p>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${product.sold ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'}">
                                        ${product.sold ? '已售出' : '在售'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex flex-col space-y-2">
                                <button onclick="app.editProduct(${product.id})" class="text-primary hover:text-primary/80 text-sm">编辑</button>
                                ${user.role === 'admin' ? 
                                    `<button onclick="app.confirmDeleteProduct(${product.id})" class="text-red-500 hover:text-red-700 text-sm">删除</button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = productsHTML;
            }

            filterProducts(filterText) {
                this.renderProducts(filterText);
            }

            updateStats() {
                const products = this.store.getProducts();
                const total = products.length;
                const sold = products.filter(p => p.sold).length;
                const stock = products.filter(p => !p.sold).length;
                const totalValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);

                document.getElementById('totalProducts').textContent = total;
                document.getElementById('soldProducts').textContent = sold;
                document.getElementById('stockProducts').textContent = stock;
                document.getElementById('totalValue').textContent = `¥${totalValue.toFixed(2)}`;
            }

            showProductModal(product = null) {
                this.currentEditingProduct = product;
                const modal = document.getElementById('productModal');
                const title = document.getElementById('productModalTitle');
                const form = document.getElementById('productForm');

                title.textContent = product ? '编辑商品' : '添加商品';
                
                if (product) {
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productSold').checked = product.sold;
                    
                    if (product.image) {
                        document.getElementById('imagePreview').classList.remove('hidden');
                        document.getElementById('previewImg').src = product.image;
                    }
                } else {
                    form.reset();
                    document.getElementById('imagePreview').classList.add('hidden');
                }

                modal.classList.remove('hidden');
            }

            hideProductModal() {
                document.getElementById('productModal').classList.add('hidden');
                document.getElementById('productForm').reset();
                document.getElementById('imagePreview').classList.add('hidden');
                this.currentEditingProduct = null;
            }

            handleImagePreview(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // 创建图片对象来调整尺寸
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // 设置目标尺寸
                            canvas.width = 1600;
                            canvas.height = 2048;
                            
                            // 计算缩放比例以保持纵横比
                            const scaleX = canvas.width / img.width;
                            const scaleY = canvas.height / img.height;
                            const scale = Math.min(scaleX, scaleY);
                            
                            const scaledWidth = img.width * scale;
                            const scaledHeight = img.height * scale;
                            
                            // 居中绘制
                            const x = (canvas.width - scaledWidth) / 2;
                            const y = (canvas.height - scaledHeight) / 2;
                            
                            // 填充白色背景
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // 绘制图片
                            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                            
                            // 获取调整后的图片数据
                            const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            
                            document.getElementById('imagePreview').classList.remove('hidden');
                            document.getElementById('previewImg').src = resizedDataUrl;
                            
                            // 保存调整后的图片数据
                            event.target.dataset.resizedImage = resizedDataUrl;
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            handleProductSubmit() {
                const name = document.getElementById('productName').value;
                const category = document.getElementById('productCategory').value;
                const price = parseFloat(document.getElementById('productPrice').value);
                const stock = parseInt(document.getElementById('productStock').value);
                const sold = document.getElementById('productSold').checked;
                const imageInput = document.getElementById('productImage');
                
                let image = null;
                if (imageInput.dataset.resizedImage) {
                    image = imageInput.dataset.resizedImage;
                } else if (this.currentEditingProduct) {
                    image = this.currentEditingProduct.image;
                }

                const productData = { name, image, category, price, stock, sold };

                if (this.currentEditingProduct) {
                    this.store.updateProduct(this.currentEditingProduct.id, productData);
                } else {
                    this.store.addProduct(productData);
                }

                this.hideProductModal();
                this.renderProducts();
                this.updateStats();
            }

            editProduct(id) {
                const product = this.store.getProducts().find(p => p.id === id);
                if (product) {
                    this.showProductModal(product);
                }
            }

            confirmDeleteProduct(id) {
                this.showConfirmModal('确定要删除此商品吗？', () => {
                    this.store.deleteProduct(id);
                    this.renderProducts();
                    this.updateStats();
                });
            }

            // 用户管理相关方法
            renderUsers() {
                const container = document.getElementById('usersList');
                const users = this.store.getUsers();
                const currentUser = this.store.getCurrentUser();

                const usersHTML = users.map(user => `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium text-gray-900 dark:text-white">${user.username}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    角色: ${user.role === 'admin' ? '管理员' : '员工'}
                                </p>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${user.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                        ${user.status === 'active' ? '启用' : '禁用'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                ${user.id !== currentUser.id ? `
                                    <button onclick="app.toggleUserStatus(${user.id})" class="text-primary hover:text-primary/80 text-sm">
                                        ${user.status === 'active' ? '禁用' : '启用'}
                                    </button>
                                    <button onclick="app.editUser(${user.id})" class="text-primary hover:text-primary/80 text-sm">编辑</button>
                                    <button onclick="app.confirmDeleteUser(${user.id})" class="text-red-500 hover:text-red-700 text-sm">删除</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = usersHTML;
            }

            showUserModal(user = null) {
                this.currentEditingUser = user;
                const modal = document.getElementById('userModal');
                const title = document.getElementById('userModalTitle');
                const form = document.getElementById('userForm');

                title.textContent = user ? '编辑用户' : '添加员工';
                
                if (user) {
                    document.getElementById('newUsername').value = user.username;
                    document.getElementById('newPassword').value = user.password;
                    document.getElementById('userRole').value = user.role;
                } else {
                    form.reset();
                }

                modal.classList.remove('hidden');
            }

            hideUserModal() {
                document.getElementById('userModal').classList.add('hidden');
                document.getElementById('userForm').reset();
                this.currentEditingUser = null;
            }

            handleUserSubmit() {
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const role = document.getElementById('userRole').value;

                const userData = { username, password, role };

                if (this.currentEditingUser) {
                    this.store.updateUser(this.currentEditingUser.id, userData);
                } else {
                    this.store.addUser(userData);
                }

                this.hideUserModal();
                this.renderUsers();
            }

            editUser(id) {
                const user = this.store.getUsers().find(u => u.id === id);
                if (user) {
                    this.showUserModal(user);
                }
            }

            toggleUserStatus(id) {
                const user = this.store.getUsers().find(u => u.id === id);
                if (user) {
                    const newStatus = user.status === 'active' ? 'disabled' : 'active';
                    this.store.updateUser(id, { status: newStatus });
                    this.renderUsers();
                }
            }

            confirmDeleteUser(id) {
                this.showConfirmModal('确定要删除此用户吗？', () => {
                    this.store.deleteUser(id);
                    this.renderUsers();
                });
            }

            // 分类管理相关方法
            renderCategories() {
                const container = document.getElementById('categoriesList');
                const categories = this.store.getCategories();

                const categoriesHTML = categories.map(category => `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium text-gray-900 dark:text-white">${category}</h3>
                            </div>
                            <div>
                                <button onclick="app.confirmDeleteCategory('${category}')" class="text-red-500 hover:text-red-700 text-sm">删除</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = categoriesHTML || '<div class="text-center py-12 text-gray-500 dark:text-gray-400">暂无分类</div>';
            }

            showCategoryModal() {
                const modal = document.getElementById('categoryModal');
                const form = document.getElementById('categoryForm');
                
                form.reset();
                modal.classList.remove('hidden');
            }

            hideCategoryModal() {
                document.getElementById('categoryModal').classList.add('hidden');
                document.getElementById('categoryForm').reset();
            }

            handleCategorySubmit() {
                const name = document.getElementById('categoryName').value;
                
                if (this.store.addCategory(name)) {
                    this.hideCategoryModal();
                    this.renderCategories();
                    this.updateProductCategories();
                } else {
                    this.showAlert('分类已存在');
                }
            }

            confirmDeleteCategory(categoryName) {
                this.showConfirmModal('确定要删除此分类吗？', () => {
                    this.store.deleteCategory(categoryName);
                    this.renderCategories();
                    this.updateProductCategories();
                });
            }

            // 统计相关方法
            renderStats() {
                const products = this.store.getProducts();
                const categories = this.store.getCategories();
                
                // 分类统计
                const categoryStats = categories.map(category => {
                    const categoryProducts = products.filter(p => p.category === category);
                    const total = categoryProducts.length;
                    const sold = categoryProducts.filter(p => p.sold).length;
                    const revenue = categoryProducts.filter(p => p.sold).reduce((sum, p) => sum + p.price, 0);
                    
                    return { category, total, sold, revenue };
                });

                const categoryStatsHTML = categoryStats.map(stat => `
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-3 mb-3 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${stat.category}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${stat.total} 件商品</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            已售: ${stat.sold} 件 | 收入: ¥${stat.revenue.toFixed(2)}
                        </div>
                    </div>
                `).join('');

                document.getElementById('categoryStats').innerHTML = categoryStatsHTML || '<div class="text-gray-500 dark:text-gray-400">暂无数据</div>';

                // 销售统计
                const totalRevenue = products.filter(p => p.sold).reduce((sum, p) => sum + p.price, 0);
                const avgPrice = products.length > 0 ? products.reduce((sum, p) => sum + p.price, 0) / products.length : 0;
                
                const salesStatsHTML = `
                    <div class="space-y-4">
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-3">
                            <div class="text-2xl font-bold text-primary">¥${totalRevenue.toFixed(2)}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">总收入</div>
                        </div>
                        <div class="border-b border-gray-200 dark:border-gray-700 pb-3">
                            <div class="text-2xl font-bold text-green-500">¥${avgPrice.toFixed(2)}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">平均商品价格</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-500">${products.filter(p => p.sold).length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">已售商品数量</div>
                        </div>
                    </div>
                `;

                document.getElementById('salesStats').innerHTML = salesStatsHTML;
            }

            // 通用确认模态框
            showConfirmModal(message, callback) {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.remove('hidden');
                this.confirmCallback = callback;
            }

            hideConfirmModal() {
                document.getElementById('confirmModal').classList.add('hidden');
                this.confirmCallback = null;
            }

            // 通用提示
            showAlert(message) {
                const alertModal = document.createElement('div');
                alertModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay';
                alertModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm mx-4">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold mb-4">提示</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">${message}</p>
                            <div class="flex justify-end">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">确定</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            }
        }

        // 初始化应用
        const app = new InventoryApp();
    </script>


</body></html>